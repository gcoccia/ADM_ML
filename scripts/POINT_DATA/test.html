<html>
  <head>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
    <script src="http://code.highcharts.com/highcharts.js" type="text/javascript"></script>
    <script src="http://code.highcharts.com/modules/exporting.js" type="text/javascript"></script>
    <script type="text/javascript"> 

/*Declare variables*/
var data_in;
var chart;
var varinfo = {
	name:[]
	}

var options = {
    xAxis: {type: 'datetime',},
    legend: {layout: 'horizontal',align: 'center',verticalAlign: 'bottom',},
};

/*Obtain all the data at once from the server*/
function RequestData() {
 idate = Date.UTC(parseInt($("#iyear").val()),parseInt($("#imonth").val()-1),parseInt($("#iday").val()))/1000;
 fdate = Date.UTC(parseInt($("#fyear").val()),parseInt($("#fmonth").val()-1),parseInt($("#fday").val())+1)/1000;
 lat = $("#latitude").val();
 lon = $("#longitude").val();
 tstep = $('input:radio[name=tstep]:checked').val();//"DAILY";
 script = 'python ReadStationData.py'
 input = {idate:idate,fdate:fdate,tstep:tstep,lat:lat,lon:lon,};
 input = JSON.stringify(input);
 request = {script:script,input:input};
 $.ajax({
  type:"post",
  url: 'Jquery_Python_JSON_Glue.php',
  data: request,
  success: function(response){
   DATA = JSON.parse(response);
  },
  async: false,
  cache: false
 });	
}

$(function() {
 //LoadInitialInfo();
});

function Request_and_Display() {
 RequestData();
 Initialize_Controls(); 
 $('#container').highcharts(options);
};

function UpdateChart(variable){

 chart = $('#container').highcharts();
 //Remove the variable and possibly its axis
 if (chart.get(variable) != undefined){ 
  //Determine the current variable's axis
  yAxis = chart.get(variable).yAxis
  //Remove the current variable
  chart.get(variable).remove();
  //If there aren't anymore series with the current axis, then remove it
  if(yAxis.series.length == 0){yAxis.remove();};
 }
 //Add a variable and possibly its axis
 else{
  VARIABLE = DATA["VARIABLES"][variable];
  //Determine last assigned yAxis and update as necessary
  if (chart.series.length == 0){yAxis_id = 0;}
  if (chart.series.length > 0 & ($('input:radio[name=axis]:checked').val()) == 'yes'){
   yAxis_id = chart.series[chart.series.length - 1].yAxis.options.id + 1}
  //Define the new series
  var series = {
   color: ($('input:radio[name=color]:checked').val()),
   type: ($('input:radio[name=type]:checked').val()),
   data: VARIABLE["data"],
   name: variable,
   id: variable,
   pointInterval: DATA["TIME"]["pointInterval"],
   pointStart: Date.UTC(DATA["TIME"]["iyear"],DATA["TIME"]["imonth"]-1,DATA["TIME"]["iday"]),
   yAxis: yAxis_id,
  };
  //Create the new axis if necessary
  if (($('input:radio[name=axis]:checked').val()) == 'yes'){
   var yAxis = {
    title: {text: VARIABLE["units"]},
    name: yAxis_id,
    id: yAxis_id,
   }
   chart.addAxis(yAxis,false);
  };
  chart.addSeries(series,false);
  chart.redraw();
 };
};

function Initialize_Controls(){
 //Remove anything in the controls div
 $('#controls').empty();
 //Fill in with the new controls
 for (variable in DATA["VARIABLES"]){
  $('#controls').append('<input type="checkbox" id="' + variable + '" onclick=UpdateChart("' + variable + '")>' + variable + ' ')
 };
 $('#controls').append('<br>')
 $('#controls').append('Color:')
 $('#controls').append('<input type="radio" name="color" value="red" checked=checked>red')
 $('#controls').append('<input type="radio" name="color" value="blue" >blue')
 $('#controls').append('<br>')
 $('#controls').append('Type:')
 $('#controls').append('<input type="radio" name="type" value="line" >line')
 $('#controls').append('<input type="radio" name="type" value="bar" checked=checked>column')
 $('#controls').append('<br>')
 $('#controls').append('New Axis:')
 $('#controls').append('<input type="radio" name="axis" value="yes" >yes')
 $('#controls').append('<input type="radio" name="axis" value="no" checked=checked>no')
 $('#controls').append('<br>')
};

function PrepareData(){
 chart = $('#container').highcharts();
 for (id in chart['options']['yAxis']){
  yAxis = chart['options']['yAxis'][id]
 }
}
  
    </script>
  </head>

  <body>
    <div id="container"></div>
    <div id="controls"></div>
    Time Step:
    <input type="radio" name="tstep" value="DAILY" checked=checked>Daily
    <input type="radio" name="tstep" value="MONTHLY" >Monthly
    <input type="radio" name="tstep" value="YEARLY" >Yearly
    <br>
    <!-- Date info -->
    Initial Time: 
    <input type="text" id="iyear" value=2001>
    <input type="text" id="imonth" value=1>
    <input type="text" id="iday" value=1>
    <br>
    Final Time:  
    <input type="text" id="fyear" value=2001>
    <input type="text" id="fmonth" value=1>
    <input type="text" id="fday" value=10>
    <br>
    Latitude:
    <input type="text" id="latitude" value=-34.6250>
    Longitude:
    <input type="text" id="longitude" value=19.8750>
    <br>
    <button onclick="Request_and_Display()">Request Data</button>
  </body>
</html>
